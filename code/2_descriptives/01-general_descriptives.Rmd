---
title: "General Descriptives"
author: "Johanna Mehler"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true               # Enable Table of Contents
    toc_float:              # Make the TOC floating
      collapsed: false      # Do not collapse TOC by default
      smooth_scroll: true   # Smooth scrolling to sections
    number_sections: true   # Numbered sections
    theme: readable         # Use a predefined theme for styling (optional)
    highlight: tango        # Syntax highlighting style (optional)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# General Descriptives

```{r}
library(tidyverse)
library(ggplot2)
library(here)
library(table1)

# load reprocessed data
data <- read_csv(here("data/data_combined.csv"))
```
## Distribution of Variables of Interest

```{r}
table1(~ academic_status + age_cat + gender + polinterest_cat_3 + empathy_pc_cat + exp_hate_speech_cat + exp_hostile_engagement_cat, data = data)
```


## Education Levels

```{r}
#data_all <- read_csv(here("data/data_clean.csv"))
#
#data_all %>% colnames()
```



# Missingness Sociodemographics

```{r}

# load reprocessed data
data_all <- read_csv(here("data/data_clean.csv"))
data_controls <- read_csv(here("data/controls.csv"))

# join data by ResponseId
data <- inner_join(data_all, data_controls, by = "ResponseId")

# select hate definition, edu variables, and controls 
data <- data %>% select(open_hatedefinition, gender.x, age_cat.x, minority_cat.y, educ_cat,  empathy_pc_cat, polinterest_cat_3, exp_hate_speech_cat, exp_hostile_engagement_cat)

## More Covariates ####
## select variables of interest
#data <- data_all %>% select(open_hatedefinition, gender, age_cat, minority_cat, educ_cat, #academic_status, polinterest_cat, empathy_person, empathy_predicting, empathy_perspective, #speak_freely, speak_freely_pers, silencing_harmful, silencing_unacceptable, starts_with("exp"), #tradeoffs_speech) 
```

### Missingness of Hate Speech Definition

```{r}
total <- data %>% count()

n <- data %>% filter(is.na(open_hatedefinition)) %>% count()

share <- n/total

share
```


Hate Definition (open_hatedefinition): 19.4 (24.1???) per cent missing. Seen that there is high missingness of nearly a quarter in my outcome variable, I want to find out more about people who did not specify their own definition of hate speech.


## Subset data in missing and not missing the hate speech definition

```{r}
# Filter rows where open_hatedefinition is missing
missing_hatedef <- data %>% 
  filter(is.na(open_hatedefinition)) 

not_missing_hatedef <- data %>% 
  filter(!is.na(open_hatedefinition)) 

# Create vector of variable names
variables <- data %>% select(-open_hatedefinition) %>% colnames()
```

## Calculate Percentages of each value in each group

```{r}
## group "missing"
#
## convert to long format
#missing_hatedef_long <- missing_hatedef %>% 
#  pivot_longer(cols = variables, names_to = "variable", values_to = "value")
#
## summarize counts
#missing_hatedef_summary <- missing_hatedef_long %>% group_by(variable, value) %>% count()
#
## calculate total of each variable
#total <- missing_hatedef %>% nrow()
#
## add total and share of each value, and dataset variable "missing"
#missing_hatedef_summary <- missing_hatedef_summary %>% mutate(
#  total = total,
#  share = n/total,
#  dataset = "Missing"
#)
#
## group "not missing"
#
## convert to long format
#not_missing_hatedef_long <- not_missing_hatedef %>% 
#  pivot_longer(cols = variables, names_to = "variable", values_to = "value")
#
## summarize counts
#not_missing_hatedef_summary <- not_missing_hatedef_long %>% group_by(variable, value) %>% count()
#
## calculate total of each variable
#total <- not_missing_hatedef %>% nrow()
#
## add total and share of each value, and dataset variable "not missing"
#not_missing_hatedef_summary <- not_missing_hatedef_summary %>% mutate(
#  total = total,
#  share = n/total,
#  dataset = "Not Missing"
#)
#
## combine missing and not missing dataset summaries
#missingness_sociodemographics <- rbind(missing_hatedef_summary, not_missing_hatedef_summary)
#```
#
### Create plots
#
#```{r, fig.width=9, fig.height=4}
## plot with geom_point
#missingness_sociodemographics %>% 
#  ggplot(aes(x = share, y = value)) +
#  geom_point(aes(color = dataset), stat = "identity") + # Use geom_bar to create a bar plot
#  geom_line(aes(group = value), color = "black", show.legend = FALSE) +
#  facet_wrap(~variable, scales = "free", ncol = 3) + # Separate plots for each Region
#  labs(title = "Sociodemographics of those Missing compared to existing answers", x = "Share", y = #"Value")
#```
#
#Are these differences significant? 
#
#```{r, fig.width=10, fig.height=4}
## plot without line but with confident intervals
#
## Add standard error and confidence interval bounds to the dataframe
#missingness_sociodemographics <- missingness_sociodemographics %>%
#  mutate(
#    share = as.numeric(share), # Ensure that 'share' is numeric
#    SE = sqrt(share * (1 - share) / total), # Standard error of the proportion
#    z_value = qnorm(0.975), # z-value for a 95% CI
#    lower = share - z_value * SE, # Lower bound of the CI
#    upper = share + z_value * SE # Upper bound of the CI
#  )
#
## create the plot with point ranges
#ggplot(missingness_sociodemographics, aes(x = factor(value), y = share, color = dataset)) +
#  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 0.1), fatten = #3) +
#  facet_wrap(~variable, scales = "free", ncol = 3) +
#  labs(title = "Sociodemographics of those Missing compared to existing answers",
#       x = "Value", y = "Share") +
#  scale_x_discrete(na.translate = FALSE) + # remove NA values from the x-axis
#  coord_flip()
#```
#
#People who did not answer...
#
#* have less academic education
#* are more often between 18 and 29 and more rare in the age group 50-69
#* ...
#* ...
#* ...
#
#X, Y and Z seem to be not significantly different between the groups of missing and not missing #answers.
#
#The high missingness quota could also be traced back to the very long survey experiment and missing #incentives to take a lot of time at the end to answer the questions (answering time for the open text #questions was highest compared to all other items of the survey).
#
#
### Bar plot
#
#```{r, fig.width=8, fig.height=8}
## bar plot
#missingness_sociodemographics %>%
#  ggplot(aes(x = value, y = share, fill = dataset)) +
#  geom_bar(stat = "identity", position = position_dodge(width = 0.75)) + 
#  geom_errorbar(aes(ymin = lower, ymax = upper, group = dataset),
#                width = 0.3,                    # Width of the horizontal lines at the ends of error #bars
#                position = position_dodge(0.75), # Match the position_dodge width with geom_bar
#                color = "black",                 # Color of the error bars
#                size = 0.5) +                   # Size of the error bars, making them narrow
#  facet_wrap(~variable, scales = "free", ncol = 2) +
#  labs(title = "Missingness Sociodemographics", x = "Value", y = "Share") +
#  scale_x_discrete(na.translate = FALSE) +
#  coord_flip()
#
```

# NEW APPROACH DIFFERENT PERCENTAGES

```{r}
# Create vector of variable names
variables <- data %>% select(-open_hatedefinition) %>% colnames()

# Function to summarize data by missingness
summarize_data <- function(data, dataset_name) {
  data %>%
    pivot_longer(cols = all_of(variables), names_to = "variable", values_to = "value") %>%
    group_by(variable, value) %>%
    summarise(count = n(), .groups = "drop") %>%
    mutate(dataset = dataset_name)
}

# Filter rows where open_hatedefinition is missing and not missing
missing_hatedef <- data %>% filter(is.na(open_hatedefinition))
not_missing_hatedef <- data %>% filter(!is.na(open_hatedefinition))

# Apply the summarization function
missing_summary <- summarize_data(missing_hatedef, "Missing")
not_missing_summary <- summarize_data(not_missing_hatedef, "Not Missing")

# Combine summaries and calculate share
combined_summary <- rbind(missing_summary, not_missing_summary) %>%
  group_by(variable, value, dataset) %>%
  summarise(count = sum(count), .groups = "drop") %>%
  group_by(variable, value) %>%
  mutate(total = sum(count), share = count / total)

# View the combined summary
print(combined_summary)

```

## Bar plot

```{r, fig.width=8, fig.height=8}
# bar plot
combined_summary %>%
  ggplot(aes(x = value, y = share, fill = dataset)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75)) + 
#  geom_errorbar(aes(ymin = lower, ymax = upper, group = dataset),
#                width = 0.3,                    # Width of the horizontal lines at the ends of error #bars
#                position = position_dodge(0.75), # Match the position_dodge width with geom_bar
#                color = "black",                 # Color of the error bars
#                size = 0.5) +                   # Size of the error bars, making them narrow
  facet_wrap(~variable, scales = "free", ncol = 2) +
  labs(title = "Missingness Sociodemographics", x = "Value", y = "Share") +
  scale_x_discrete(na.translate = FALSE) +
  coord_flip()

```



## ADDING CONFIDENCE INTERVALS

```{r}
# Create vector of variable names
variables <- data %>% select(-open_hatedefinition) %>% colnames()

# Function to summarize data by missingness
summarize_data <- function(data, dataset_name) {
  data %>%
    pivot_longer(cols = all_of(variables), names_to = "variable", values_to = "value") %>%
    group_by(variable, value) %>%
    summarise(count = n(), .groups = "drop") %>%
    mutate(dataset = dataset_name)
}

# Filter rows where open_hatedefinition is missing and not missing
missing_hatedef <- data %>% filter(is.na(open_hatedefinition))
not_missing_hatedef <- data %>% filter(!is.na(open_hatedefinition))

# Apply the summarization function
missing_summary <- summarize_data(missing_hatedef, "Missing")
not_missing_summary <- summarize_data(not_missing_hatedef, "Not Missing")

# Combine summaries and calculate share and confidence intervals
combined_summary <- rbind(missing_summary, not_missing_summary) %>%
  group_by(variable, value, dataset) %>%
  summarise(count = sum(count), .groups = "drop") %>%
  group_by(variable, value) %>%
  mutate(total = sum(count), 
         share = count / total,
         se = sqrt(share * (1 - share) / total),  # Standard error of the proportion
         lower = share - 1.96 * se,              # Lower bound of 95% CI
         upper = share + 1.96 * se)              # Upper bound of 95% CI

# View the combined summary
print(combined_summary)

```

### Plot

```{r}
# Bar plot with error bars with customizable plot and legend titles
combined_summary %>%
  ggplot(aes(x = value, y = share, fill = dataset)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75)) +
  geom_errorbar(aes(ymin = lower, ymax = upper, group = dataset),
                width = 0.3,                    # Width of the horizontal lines at the ends of error bars
                position = position_dodge(0.75), # Match the position_dodge width with geom_bar
                color = "black",                 # Color of the error bars
                size = 0.5) +                   # Size of the error bars, making them narrow
  facet_wrap(~variable, scales = "free", ncol = 2, labeller = label_bquote(cols = .(variable))) +
  labs(title = "Missingness Sociodemographics", 
       x = "Value", 
       y = "Share",
       fill = "Dataset Type") +  # Custom legend title for the fill aesthetic
  scale_x_discrete(na.translate = FALSE) +
  coord_flip()

```

### Plot with stacked bars

```{r}


# Assuming combined_summary is already defined and correct
# Bar plot with error bars with custom facet titles and stacked bars
combined_summary %>%
  ggplot(aes(x = value, y = share, fill = dataset)) +
  geom_bar(stat = "identity", position = "stack") +  # Change to stacked bars
#  geom_errorbar(aes(ymin = lower, ymax = upper, group = dataset),
#                width = 0.3,                         # Width of the horizontal lines at the ends of #error bars
#                position = position_dodge(0.75),      # Adjust if necessary for clarity
#                color = "black",                      # Color of the error bars
#                size = 0.5) +                        # Size of the error bars, making them narrow
  facet_wrap(~variable, scales = "free", ncol = 2,
             labeller = as_labeller(c("age_cat.x" = "Age", "educ_cat" = "Education", "empathy_pc_cat" = "Empathy", "exp_hate_speech_cat" = "Hate Speech", "exp_hostile_engagement_cat" = "Online hostile engagement", "gender.x" = "Gender", "minority_cat.y" = "Minority Status", "polinterest_cat_3" = "Political Interest"))) +
  labs(title = "Missingness Sociodemographics", 
       x = "Value", 
       y = "Share",
       fill = "Dataset Type") +  # Custom legend title for the fill aesthetic
  scale_x_discrete(na.translate = FALSE) +
  coord_flip()


```



### Plot with only missing and confidence intervals

```{r}
combined_summary_missing <- combined_summary %>% filter(dataset == "Missing")

# Bar plot with error bars with customizable plot and legend titles
combined_summary_missing %>%
  ggplot(aes(x = value, y = share)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), fill = "skyblue", color = "white") +
  geom_errorbar(aes(ymin = lower, ymax = upper, group = dataset),
                width = 0.3,                    # Width of the horizontal lines at the ends of error bars
                position = position_dodge(0.75), # Match the position_dodge width with geom_bar
                color = "black",                 # Color of the error bars
                size = 0.5) +                   # Size of the error bars, making them narrow
  facet_wrap(~variable, scales = "free", ncol = 2,
             labeller = as_labeller(c("age_cat.x" = "Age", "educ_cat" = "Education", "empathy_pc_cat" = "Empathy", "exp_hate_speech_cat" = "Hate Speech", "exp_hostile_engagement_cat" = "Online hostile engagement", "gender.x" = "Gender", "minority_cat.y" = "Minority Status", "polinterest_cat_3" = "Political Interest"))) +
  labs(title = "Missingness of Hate Speech Defenitions by Subgroup", 
       x = "Subgroup", 
       y = "Share of Missingness") +
  scale_x_discrete(na.translate = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold")  # Make facet titles bold
  )

ggsave("missingness.png", path = here("figures"))
```