---
title: "Academic Status / Education Moderation"
author: "Johanna Mehler"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true               # Enable Table of Contents
    toc_float:              # Make the TOC floating
      collapsed: false      # Do not collapse TOC by default
      smooth_scroll: true   # Smooth scrolling to sections
    number_sections: true   # Numbered sections
    theme: readable         # Use a predefined theme for styling (optional)
    highlight: tango        # Syntax highlighting style (optional)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(stats)
library(GGally)
library(corrplot)
library(descr)
library(sjPlot)
library(nnet)
```


# Prepare Data

```{r}
data <- read_csv(here("data", "data_combined.csv"), 
                 col_types = cols(
                   academic_status = col_factor(levels = c("non-academic", "academic")),
                   educ_cat = col_factor(levels = c("Low", "Intermediate", "High")), 
                   gender = col_factor(levels = c("Male", "Female", "Other")), 
                   monority_cat = col_factor(levels = c("Non-minority", "Minority")),
                   age_cat = col_factor(levels = c("18-29", "30-49", "50-69", "70+")),
                   polinterest_cat_3 = col_factor(levels = c("Low", "Intermediate", "High")),
                   empathy_pc_cat = col_factor(levels = c("Less empathetic", "More empathetic")),
                   exp_hate_speech_cat = col_factor(levels = c("Less experience", "More experience")), 
                   exp_hostile_engagement_cat = col_factor(levels = c("Less experience", "More experience")), 
                   cluster = col_factor(levels = c("Intent-based", "Harms-based", "Harms-based narrow", "Denying/Nonsense")),
                   leftright_cat = col_factor(levels = c("liberal/left", "moderate/center", "conservative/right")),
                   commitment_cat = col_factor(levels = c("Below average", "Above Average"))
                 ))

# remove NA's in academic status and extreme outliers in readability and textlength (only one observation each)
data <- data %>% filter(!is.na(academic_status), text_length < 2500, readability_score < 40)

# select indicators
data_indicators <- data %>% select(text_length_log2, readability_score, cluster, leftright_pred_error)

# select controls (categorical)
controls_cat <- data %>% select(academic_status, gender, age_cat, polinterest_cat_3, leftright_cat, empathy_pc_cat, exp_hate_speech_cat, exp_hostile_engagement_cat, commitment_cat)

# select controls (numerical)
controls_num <- data %>% select(academic_status, age10, polinterest, leftright, empathy_pc, exp_hate_speech, exp_hostile_engagement, commitment_log2)
```


## Academic Status as Moderator

Create Function how ACADEMIC STATUS moderates the relationship between controls (covariates) and indicators (outcomes)

### Function for Interaction Model and Modelplot

```{r}
# For numeric outcomes
lin_model_interaction <- function(data, var1, var2) {
  # Construct the formula as a string
  formula_str <- paste0(var2, " ~ academic_status:", var1, " + gender + age_cat + leftright_cat + commitment_log2")
  
  # Convert the string to a formula
  formula_obj <- as.formula(formula_str)
  
  # Fit the model
  MODEL <- glm(formula_obj, data = data)
  
  # Use plot_model() to visualize the interaction
  plot <- plot_model(MODEL, type = "pred", 
                     terms = c(var1, "academic_status"), 
                     title = paste("Predicted", var2, "\nby", var1, "moderated by Academic Status", "\ncontrolled for Gender, Age and Survey Commitment"), 
                     colors = c("skyblue", "orange"), 
                     axis.title = c(var1, var2), 
                     legend.title = "Academic Status") +
    theme_bw()
  
  # save plot
  plot_name <- paste0("plot_", var1, "_by_", var2)
  assign(plot_name, plot, envir = .GlobalEnv)
  
  # save figure
  ggsave(filename = paste0("3-4-", var1, "_by_", var2, ".png"), plot = plot, path = here("figures"), device = "png")
  
  print(plot)
}
```


Multinomial Regression

```{r}
# For Clusters (multinomial logistic regression)
multinom_model_interaction <- function(data, var1, var2) {
  # Construct the formula as a string
  formula_str <- paste0(var2, " ~ academic_status:", var1, " + gender + age_cat + leftright_cat + commitment_log2")
  
  # Convert the string to a formula
  formula_obj <- as.formula(formula_str)
  
  # Fit the model
  MODEL <- multinom(formula_obj, data = data)
  
  # Use plot_model() to visualize the interaction
  plot <- plot_model(MODEL, type = "pred", 
                     terms = c(var1, "academic_status"), 
                     title = paste("Predicted probabilities of", var2, "\nby", var1, "moderated by Academic Status", "\ncontrolled for Gender, Age and Survey Commitment"), 
                     colors = c("skyblue", "orange"), 
                     axis.title = c(var1, "Probability"), 
                     legend.title = "Academic Status",
                     ci.lvl = 0.95) +
    theme_bw() +
    theme()
    coord_flip()
  
  # Adjusting the plot by redefining aesthetic mappings
  plot + geom_point(aes(shape = factor(academic_status)), data = data)  # Map shapes to academic status
  #  scale_shape_manual(values = c(19, 17)) +  # Assign specific shapes
  
  # save plot
  plot_name <- paste0("plot_", var1, "_by_", var2)
  assign(plot_name, plot, envir = .GlobalEnv)
  
  # save figure
  ggsave(filename = paste0("3-4-", var1, "_by_", var2, ".png"), plot = plot, path = here("figures"), device = "png")
  
  print(plot)
}
```


### Function for scatter plot and group comparison

```{r}
# Function to plot a scatter plot between any two specified variables in a dataframe
plot_scatter <- function(df, var1, var2) {
  # Check if the specified variable names are present in the dataframe
  if (!(var1 %in% names(df)) || !(var2 %in% names(df))) {
    stop("One or both of the specified variables are not in the dataframe")
  }
  
  # Create general scatter plot
  plot1 <- ggplot(df, aes_string(x = var1, y = var2)) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    theme_minimal() +
    labs(title = paste("Relationship between", var1, "and", var2))
  
  # Create the moderation scatter plot
  plot2 <- ggplot(df, aes_string(x = var1, y = var2, color = "academic_status")) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    facet_wrap(vars(academic_status), ncol = 2) +
    theme_minimal() +
    labs(title = paste("Relationship between", var1, "and", var2, "by Academic Status")) +
    theme(legend.position = "none")
  
  # Print the plots
  print(plot1)
  print(plot2)
}

# create function for cluster indicator (because it is a factor variable)
library(rlang)
```

### Function for Boxplots, because of categorical cluster variable

```{r}
boxplot_cluster <- function(df, var) {
  # Convert the string to a symbol and unquote it
  var_sym <- sym(var)
  
  # Create the box plot using tidy evaluation
  plot <- ggplot(df, aes(x = factor(cluster), y = !!var_sym)) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
    geom_boxplot(outliers = FALSE) +
    theme_minimal() +
    labs(title = "Comparison of Clusters",
         x = "Cluster",
         y = var_sym)
  
  # Print the plot
  print(plot)
}
```


# Plot relationships with moderation

Chose the variables that are in the causal chain "after" education - such as political interest. Because education probably affects these "controls" as well.

```{r}
# check colnames to find out which variables to compare in the following section
data %>% colnames()
```


## Political Interest

```{r}
# textlength
# plot_scatter(data, "polinterest", "text_length")
# model_interaction(data, "polinterest", "text_length")
lin_model_interaction(data, "polinterest_cat_3", "text_length_log2")

# readability
# plot_scatter(data, "polinterest", "readability_score")
# model_interaction(data, "polinterest", "readability_score")
lin_model_interaction(data, "polinterest_cat_3", "readability_score")

# cluster
# plot_scatter(data, "cluster", "polinterest")
boxplot_cluster(data, "polinterest")
multinom_model_interaction(data, "polinterest_cat_3", "cluster")

## left-right
#plot_scatter(data, "polinterest", "leftright_pred_error")
#model_interaction(data, "polinterest", "leftright_pred_error")
#model_interaction(data, "polinterest_cat_3", "leftright_pred_error")
```

## Political Ideology

```{r}
# model_interaction(data, "leftright", "text_length")
lin_model_interaction(data, "leftright_cat", "text_length_log2")

# model_interaction(data, "leftright", "readability_score")
lin_model_interaction(data, "leftright_cat", "readability_score")

multinom_model_interaction(data, "leftright_cat", "cluster")
boxplot_cluster(data, "leftright_cat")

#model_interaction(data, "leftright_cat", "leftright_pred_error")
```


## Experience with hate speech

```{r}
# textlength with exp_hate_speech
# plot_scatter(data, "exp_hate_speech", "text_length")
# model_interaction(data, "exp_hate_speech", "text_length")
lin_model_interaction(data, "exp_hate_speech_cat", "text_length_log2")

# readability with exp_hate_speech
#plot_scatter(data, "exp_hate_speech", "readability_score")
#model_interaction(data, "exp_hate_speech", "readability_score")
lin_model_interaction(data, "exp_hate_speech_cat", "readability_score")

# cluster with exp_hate_speech
#plot_scatter(data, "cluster", "exp_hate_speech")
boxplot_cluster(data, "exp_hate_speech")
multinom_model_interaction(data, "exp_hate_speech_cat", "cluster")


## left-right with exp_hate_speech
#plot_scatter(data, "exp_hate_speech", "leftright_pred_error")
#model_interaction(data, "exp_hate_speech", "leftright_pred_error")
#model_interaction(data, "exp_hate_speech_cat", "leftright_pred_error")
```

## Experience with online hostile engagement

```{r}
# textlength with exp_hostile_engagement
#plot_scatter(data, "exp_hostile_engagement", "text_length")
#model_interaction(data, "exp_hostile_engagement", "text_length")
lin_model_interaction(data, "exp_hostile_engagement_cat", "text_length_log2")

# readability with exp_hostile_engagement
#plot_scatter(data, "exp_hostile_engagement", "readability_score")
#model_interaction(data, "exp_hostile_engagement", "readability_score")
lin_model_interaction(data, "exp_hostile_engagement_cat", "readability_score")

# cluster with exp_hostile_engagement
#plot_scatter(data, "cluster", "exp_hostile_engagement")
boxplot_cluster(data, "exp_hostile_engagement")
multinom_model_interaction(data, "exp_hostile_engagement_cat", "cluster")

## left-right with exp_hostile_engagement
#plot_scatter(data, "exp_hostile_engagement", "leftright_pred_error")
#model_interaction(data, "exp_hostile_engagement", "leftright_pred_error")
#model_interaction(data, "exp_hostile_engagement_cat", "leftright_pred_error")
```

# Adjust Plots for Displaying in Overleaf

## Text length

```{r}
# adjust y-range
common_y_range <- c(6.2, 7.4) 

# 1
polinterest_cat_3_by_text_length_log2 <- plot_polinterest_cat_3_by_text_length_log2 + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) +
  ylim(common_y_range) +
  ylab("Text length (log2)") +
  xlab("")

ggsave(filename = "3-4-polinterest_cat_3_by_text_length_log2.png", path = here("figures"))

# 2
leftright_cat_by_text_length_log2 <- plot_leftright_cat_by_text_length_log2 + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") +
  xlab("")

ggsave(filename = "3-4-leftright_cat_by_text_length_log2.png", path = here("figures"))

# 3
exp_hate_speech_cat_by_text_length_log2 <- plot_exp_hate_speech_cat_by_text_length_log2 + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  ylim(common_y_range) +
  ylab("Text length (log2)") +
  xlab("")

ggsave(filename = "3-4-exp_hate_speech_cat_by_text_length_log2.png", path = here("figures"))

# 4
exp_hostile_engagement_cat_by_text_length_log2 <- plot_exp_hostile_engagement_cat_by_text_length_log2 + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") +
  xlab("")

ggsave(filename = "3-4-exp_hostile_engagement_cat_by_text_length_log2.png", path = here("figures"))

```

## Readability

```{r}
# Adjust y-range
common_y_range <- c(10, 16) 

# 1
polinterest_cat_3_by_readability_score <- plot_polinterest_cat_3_by_readability_score + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  ylim(common_y_range) +
  ylab("Readability Score") + 
  xlab("")

ggsave(filename = "3-4-polinterest_cat_3_by_readability_score.png", plot = polinterest_cat_3_by_readability_score, path = here("figures"))

# 2
leftright_cat_by_readability_score <- plot_leftright_cat_by_readability_score + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") + 
  xlab("")

ggsave(filename = "3-4-leftright_cat_by_readability_score.png", plot = leftright_cat_by_readability_score, path = here("figures"))

# 3
exp_hate_speech_cat_by_readability_score <- plot_exp_hate_speech_cat_by_readability_score +
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) +
  ylim(common_y_range) +
  ylab("Readability Score") +
  xlab("")

ggsave(filename = "3-4-exp_hate_speech_cat_by_readability_score.png", plot = exp_hate_speech_cat_by_readability_score, path = here("figures"))

# 4
exp_hostile_engagement_cat_by_readability_score <- plot_exp_hostile_engagement_cat_by_readability_score + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 18),  # Increase x-axis label size
        axis.title.y = element_text(size = 18),  # Increase y-axis label size
        axis.text.x = element_text(size = 16),  # Increase x-axis text size
        axis.text.y = element_text(size = 16),  # Increase y-axis text size
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18)) + 
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") +  
  xlab("")

ggsave(filename = "3-4-exp_hostile_engagement_cat_by_readability_score.png", plot = exp_hostile_engagement_cat_by_readability_score, path = here("figures"))
```


## Content type

```{r}
# Adjust y-range
common_y_range <- c(0, 0.6) 

# 1
polinterest_cat_3_by_cluster <- plot_polinterest_cat_3_by_cluster + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 14),  # Increase x-axis label size
        axis.title.y = element_text(size = 14),  # Increase y-axis label size
        axis.text.x = element_text(size = 12),  # Increase x-axis text size
        axis.text.y = element_text(size = 12),  # Increase y-axis text size
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)) +
  ylim(common_y_range) +
  ylab("") 
  xlab("")

ggsave(filename = "3-4-polinterest_cat_3_by_cluster.png", plot = polinterest_cat_3_by_cluster, path = here("figures"), height = 3.5, width = 6)

# 2
leftright_cat_by_cluster <- plot_leftright_cat_by_cluster + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 14),  # Increase x-axis label size
        axis.title.y = element_text(size = 14),  # Increase y-axis label size
        axis.text.x = element_text(size = 12),  # Increase x-axis text size
        axis.text.y = element_text(size = 12),  # Increase y-axis text size
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)) +
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") + 
  xlab("")

ggsave(filename = "3-4-leftright_cat_by_cluster.png", plot = leftright_cat_by_cluster, path = here("figures"), height = 3.5, width = 6)

# 3
exp_hate_speech_cat_by_cluster <- plot_exp_hate_speech_cat_by_cluster +
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 14),  # Increase x-axis label size
        axis.title.y = element_text(size = 14),  # Increase y-axis label size
        axis.text.x = element_text(size = 12),  # Increase x-axis text size
        axis.text.y = element_text(size = 12),  # Increase y-axis text size
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)) +
  ylim(common_y_range) +
  ylab("") +
  xlab("")

ggsave(filename = "3-4-exp_hate_speech_cat_by_cluster.png", plot = exp_hate_speech_cat_by_cluster, path = here("figures"), height = 3, width = 6)

# 4
exp_hostile_engagement_cat_by_cluster <- plot_exp_hostile_engagement_cat_by_cluster + 
  theme(plot.title = element_blank(),
        axis.title.x = element_text(size = 14),  # Increase x-axis label size
        axis.title.y = element_text(size = 14),  # Increase y-axis label size
        axis.text.x = element_text(size = 12),  # Increase x-axis text size
        axis.text.y = element_text(size = 12),  # Increase y-axis text size
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)) + 
  theme(legend.position = "none") +
  ylim(common_y_range) +
  ylab("") +  
  xlab("")

ggsave(filename = "3-4-exp_hostile_engagement_cat_by_cluster.png", plot = exp_hostile_engagement_cat_by_cluster, path = here("figures"), height = 3, width = 6)
```

