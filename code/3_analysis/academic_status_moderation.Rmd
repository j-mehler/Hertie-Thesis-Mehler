---
title: "Academic Status / Education Moderation"
author: "Johanna Mehler"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true               # Enable Table of Contents
    toc_float:              # Make the TOC floating
      collapsed: false      # Do not collapse TOC by default
      smooth_scroll: true   # Smooth scrolling to sections
    number_sections: true   # Numbered sections
    theme: readable         # Use a predefined theme for styling (optional)
    highlight: tango        # Syntax highlighting style (optional)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Prepare Data

```{r}
library(tidyverse)
library(here)
library(stats)
library(GGally)
library(corrplot)
library(descr)
library(sjPlot)

data <- read_csv(here("data/data_combined.csv"))

# remove NA's in academic status and extreme outliers in readability and textlength (only one observation each)
data <- data %>% filter(!is.na(academic_status), text_length < 2500, readability_score < 40)

# select indicators
data_indicators <- data %>% select(text_length, readability_score, cluster, leftright_pred_score)

# select controls (categorical)
controls_cat <- data %>% select(academic_status, gender, age_cat, minority_cat, polinterest_cat_3, empathy_pc_cat, exp_hate_speech_cat, exp_hostile_engagement_cat)

# select controls (numerical)
controls_num <- data %>% select(academic_status, age10, minority, polinterest, empathy_pc, exp_hate_speech, exp_hostile_engagement)
```


# Create Function how ACADEMIC STATUS moderates the relationship between controls (covariates) and indicators (outcomes)

## Function for Interaction Model and Modelplot

```{r}
model_interaction <- function(data, var1, var2) {
  # Construct the formula as a string
  formula_str <- paste0(var2, " ~ academic_status:", var1, " + gender + age_cat + minority_cat")
  
  # Convert the string to a formula
  formula_obj <- as.formula(formula_str)
  
  # Fit the model
  MODEL <- glm(formula_obj, data = data)
  
  # Use plot_model() to visualize the interaction
  plot <- plot_model(MODEL, type = "pred", terms = c(var1, "academic_status"), title = paste("Predicted probabilities of", var2, "by", var1, "moderated by Academic Status"), colors = "Set2", axis.title = c(var1, var2), legend.title = "Academic Status")
  
  print(plot)
}
```

## Function for scatter plot and group comparison

```{r}
# Function to plot a scatter plot between any two specified variables in a dataframe
plot_scatter <- function(df, var1, var2) {
  # Check if the specified variable names are present in the dataframe
  if (!(var1 %in% names(df)) || !(var2 %in% names(df))) {
    stop("One or both of the specified variables are not in the dataframe")
  }
  
  # Create general scatter plot
  plot1 <- ggplot(df, aes_string(x = var1, y = var2)) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    theme_minimal() +
    labs(title = paste("Relationship between", var1, "and", var2))
  
  # Create the moderation scatter plot
  plot2 <- ggplot(df, aes_string(x = var1, y = var2, color = "academic_status")) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    facet_wrap(vars(academic_status), ncol = 2) +
    theme_minimal() +
    labs(title = paste("Relationship between", var1, "and", var2, "by Academic Status"))
  
  # Print the plots
  print(plot1)
  print(plot2)
}

# create function for cluster indicator (because it is a factor variable)
library(rlang)


```

## Function for Boxplots, because of categorical cluster variable

```{r}
boxplot_cluster <- function(df, var) {
  # Convert the string to a symbol and unquote it
  var_sym <- sym(var)
  
  # Create the box plot using tidy evaluation
  plot <- ggplot(df, aes(x = factor(cluster), y = !!var_sym)) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
    geom_boxplot(outliers = FALSE) +
    theme_minimal() +
    labs(title = "Comparison of Clusters",
         x = "Cluster",
         y = var_sym)
  
  # Print the plot
  print(plot)
}
```


## Plot relationships with moderation

Chose the variables that are in the causal chain "after" education - such as political interest. Because education probably affects these "controls".

```{r}
# check colnames to find out which variables to compare in the following section
data %>% colnames()
```


### Political Interest

First Model (Example without using the function)

```{r}
# model
MODEL <- glm(text_length ~ academic_status:polinterest + gender + age_cat + minority_cat, data = data) 
  
# show plot
plot_model(MODEL, type = "pred", terms = c("polinterest", "academic_status"),  title = "Predicted probabilities of Textlength by Academic Status", colors = "Set2", axis.title = c("Political Interest", "Textlength"), legend.title = "Academic Status")
```


```{r}
# textlength
plot_scatter(data, "polinterest", "text_length")
model_interaction(data, "polinterest", "text_length")
model_interaction(data, "polinterest_cat_3", "text_length")

# readability
plot_scatter(data, "polinterest", "readability_score")
model_interaction(data, "polinterest", "readability_score")
model_interaction(data, "polinterest_cat_3", "readability_score")

# cluster
plot_scatter(data, "cluster", "polinterest")
model_interaction(data, "cluster", "polinterest")
boxplot_cluster(data, "polinterest")

# left-right
plot_scatter(data, "polinterest", "leftright_pred_score")
model_interaction(data, "polinterest", "leftright_pred_score")
model_interaction(data, "polinterest_cat_3", "leftright_pred_score")
```


### Experience with hate speech

```{r}
# textlength with exp_hate_speech
plot_scatter(data, "exp_hate_speech", "text_length")
model_interaction(data, "exp_hate_speech", "text_length")
model_interaction(data, "exp_hate_speech_cat", "text_length")

# readability with exp_hate_speech
plot_scatter(data, "exp_hate_speech", "readability_score")
model_interaction(data, "exp_hate_speech", "readability_score")
model_interaction(data, "exp_hate_speech_cat", "readability_score")

# cluster with exp_hate_speech
plot_scatter(data, "cluster", "exp_hate_speech")
model_interaction(data, "cluster", "exp_hate_speech")
boxplot_cluster(data, "exp_hate_speech")

# left-right with exp_hate_speech
plot_scatter(data, "exp_hate_speech", "leftright_pred_score")
model_interaction(data, "exp_hate_speech", "leftright_pred_score")
model_interaction(data, "exp_hate_speech_cat", "leftright_pred_score")
```

### Experience with online hostile engagement

```{r}
# textlength with exp_hostile_engagement
plot_scatter(data, "exp_hostile_engagement", "text_length")
model_interaction(data, "exp_hostile_engagement", "text_length")
model_interaction(data, "exp_hostile_engagement_cat", "text_length")

# readability with exp_hostile_engagement
plot_scatter(data, "exp_hostile_engagement", "readability_score")
model_interaction(data, "exp_hostile_engagement", "readability_score")
model_interaction(data, "exp_hostile_engagement_cat", "readability_score")

# cluster with exp_hostile_engagement
plot_scatter(data, "cluster", "exp_hostile_engagement")
model_interaction(data, "cluster", "exp_hostile_engagement")
boxplot_cluster(data, "exp_hostile_engagement")

# left-right with exp_hostile_engagement
plot_scatter(data, "exp_hostile_engagement", "leftright_pred_score")
model_interaction(data, "exp_hostile_engagement", "leftright_pred_score")
model_interaction(data, "exp_hostile_engagement_cat", "leftright_pred_score")
```


### Empathy

```{r}
# textlength with empathy_pc
plot_scatter(data, "empathy_pc", "text_length")
model_interaction(data, "empathy_pc", "text_length")
model_interaction(data, "empathy_pc_cat", "text_length")

# readability with empathy_pc
plot_scatter(data, "empathy_pc", "readability_score")
model_interaction(data, "empathy_pc", "readability_score")
model_interaction(data, "empathy_pc_cat", "readability_score")

# cluster with empathy_pc
plot_scatter(data, "cluster", "empathy_pc")
model_interaction(data, "cluster", "empathy_pc")
boxplot_cluster(data, "empathy_pc")

# left-right with empathy_pc
plot_scatter(data, "empathy_pc", "leftright_pred_score")
model_interaction(data, "empathy_pc_cat", "leftright_pred_score")
```


# How does EDUCATION moderate the relationship between controls (covariates) and indicators (outcomes)?

## Function for Interaction Model and Modelplot

```{r}
model_interaction <- function(data, var1, var2) {
  # Construct the formula as a string
  formula_str <- paste0(var2, " ~ educ_cat:", var1, " + gender + age_cat + minority_cat")
  
  # Convert the string to a formula
  formula_obj <- as.formula(formula_str)
  
  # Fit the model
  MODEL <- glm(formula_obj, data = data)
  
  # Use plot_model() to visualize the interaction
  plot <- plot_model(MODEL, type = "pred", terms = c(var1, "educ_cat"), title = paste("Predicted probabilities of", var2, "by", var1, "moderated by Education"), colors = "Set2", axis.title = c(var1, var2), legend.title = "Education")
  
  print(plot)
}
```

## Function for Scatterplot

```{r}
# Function to plot a scatter plot between any two specified variables in a dataframe
plot_scatter <- function(df, var1, var2) {
  # Check if the specified variable names are present in the dataframe
  if (!(var1 %in% names(df)) || !(var2 %in% names(df))) {
    stop("One or both of the specified variables are not in the dataframe")
  }
  
  # create scatter plot
  plot1 <- ggplot(df, aes_string(x = var1, y = var2)) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    theme_minimal() +
    labs(title = paste("Scatter plot between", var1, "and", var2))
  
  # Create the moderation scatter plot
  plot2 <- ggplot(df, aes_string(x = var1, y = var2, color = "educ_cat")) + 
    geom_point(position = position_jitter(width = 0.2, height = 0.2), alpha = 0.6) +
    geom_smooth(method = "lm", colour = "black", linewidth = 0.5) +
    facet_wrap(vars(educ_cat), ncol = 3) +
    theme_minimal() +
    labs(title = paste("Scatter plot between", var1, "and", var2, "by Education"))
  
  # Print the plot
  print(plot1)
  print(plot2)
}
```


## Plot relationships with moderation

Chose the variables that are in the causal chain "after" education - such as political interest. Because education probably affects these "controls".

```{r}
# check colnames to find out which variables to compare in the following section
data %>% colnames()
```

### Political Interest

```{r}
plot_scatter(data, "polinterest", "text_length")
model_interaction(data, "polinterest", "text_length")
model_interaction(data, "polinterest_cat_3", "text_length")

plot_scatter(data, "polinterest", "readability_score")
model_interaction(data, "polinterest", "readability_score")
model_interaction(data, "polinterest_cat_3", "readability_score")

plot_scatter(data, "polinterest", "leftright_pred_score")
model_interaction(data, "polinterest", "leftright_pred_score")
model_interaction(data, "polinterest_cat_3", "leftright_pred_score")
```

### Experience with hate speech

```{r}
plot_scatter(data, "exp_hate_speech", "text_length")
model_interaction(data, "exp_hate_speech", "text_length")
model_interaction(data, "exp_hate_speech_cat", "text_length")

plot_scatter(data, "exp_hate_speech", "readability_score")
model_interaction(data, "exp_hate_speech", "readability_score")
model_interaction(data, "exp_hate_speech_cat", "readability_score")

plot_scatter(data, "exp_hate_speech", "leftright_pred_score")
model_interaction(data, "exp_hate_speech", "leftright_pred_score")
model_interaction(data, "exp_hate_speech_cat", "leftright_pred_score")
```

### Experience with online hostile engagement

```{r}
plot_scatter(data, "exp_hostile_engagement", "text_length")
model_interaction(data, "exp_hostile_engagement", "text_length")
model_interaction(data, "exp_hostile_engagement_cat", "text_length")

plot_scatter(data, "exp_hostile_engagement", "readability_score")
model_interaction(data, "exp_hostile_engagement", "readability_score")
model_interaction(data, "exp_hostile_engagement_cat", "readability_score")

plot_scatter(data, "exp_hostile_engagement", "leftright_pred_score")
model_interaction(data, "exp_hostile_engagement", "leftright_pred_score")
model_interaction(data, "exp_hostile_engagement_cat", "leftright_pred_score")

```

### Empathy

```{r}
plot_scatter(data, "empathy_pc", "text_length")
model_interaction(data, "empathy_pc", "text_length")
model_interaction(data, "empathy_pc_cat", "text_length")

plot_scatter(data, "empathy_pc", "readability_score")
model_interaction(data, "empathy_pc", "readability_score")
model_interaction(data, "empathy_pc_cat", "readability_score")

plot_scatter(data, "empathy_pc", "leftright_pred_score")
model_interaction(data, "empathy_pc", "leftright_pred_score")
model_interaction(data, "empathy_pc_cat", "leftright_pred_score")
```

