---
title: "Group Comparison"
author: "Johanna Mehler"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true               # Enable Table of Contents
    toc_float:              # Make the TOC floating
      collapsed: false      # Do not collapse TOC by default
      smooth_scroll: true   # Smooth scrolling to sections
    number_sections: true   # Numbered sections
    theme: readable         # Use a predefined theme for styling (optional)
    highlight: tango        # Syntax highlighting style (optional)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Differences in indicators between academic status groups

## Data preparation

```{r}
library(tidyverse)
library(here)
library(ggplot2)
library(descr)
library(GGally)
library(ggpubr)
library(rstatix)

theme_set(theme_minimal())

data <- read_csv(here("data", "data_combined.csv"), 
                 col_types = cols(
                   academic_status = col_factor(levels = c("non-academic", "academic")),
                   educ_cat = col_factor(levels = c("Low", "Intermediate", "High")), 
                   gender = col_factor(levels = c("Male", "Female", "Other")), 
                   monority_cat = col_factor(levels = c("Non-minority", "Minority")),
                   age_cat = col_factor(levels = c("18-29", "30-49", "50-69", "70+")),
                   polinterest_cat_3 = col_factor(levels = c("Low", "Intermediate", "High")),
                   empathy_pc_cat = col_factor(levels = c("Less empathetic", "More empathetic")),
                   exp_hate_speech_cat = col_factor(levels = c("Less experience", "More experience")), 
                   exp_hostile_engagement_cat = col_factor(levels = c("Less experience", "More experience")), 
                   cluster = col_factor(levels = c("Denying/Nonsense", "Intent-based", "Harms-based", "Harms-based narrow")),
                   leftright_cat = col_factor(levels = c("liberal/left", "moderate/center", "conservative/right")),
                   commitment_cat = col_factor(levels = c("Below average", "Above Average"))
                 ))

# filter out NA's in academic status and extreme outliers
data <- data %>% filter(!is.na(educ_cat), !is.na(academic_status), text_length < 1000, readability_score < 40)

indicators <- c("text_length_log2", "readability_score", "leftright_pred_error", "cluster")
```

## Indicators by Academic Status

```{r}
p <- ggpairs(data,                 # Data frame
        columns = indicators, # Columns
        aes(color = academic_status,  # Color by group (cat. variable)
            alpha = 0.5),
        upper = list(continuous = wrap("cor", size = 2.7)
        ))

p
```


### Example how to extract single plots

```{r}
getPlot(p, 1, 4)
```

### Distribution of Clusters

```{r}
getPlot(p, 4, 4)

num_academics <- data %>% filter(academic_status == "academic") %>% nrow()
num_non_academics <- data %>% filter(academic_status == "non-academic") %>% nrow()

data_cluster <- data %>% 
  select(academic_status, cluster) %>% 
  group_by(academic_status, cluster) %>% 
  count() %>% 
  mutate(share = ifelse(academic_status == "academic", n/num_academics, n/num_non_academics)) %>% 
#  arrange(cluster) %>%
  ungroup() %>% 
  # Create an ordering variable based on descending shares within each academic_status
  arrange(academic_status, desc(share)) %>% 
  mutate(order = rank(-share)) %>%
  mutate(cluster = factor(cluster, levels = unique(cluster)))

# Bar plot with error bars with and legend titles
data_cluster %>%
  ggplot(aes(x = reorder(cluster, order), y = share, fill = academic_status)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75)) +
  # Custom colors for each academic_status
  scale_fill_manual(values = c("academic" = "skyblue", "non-academic" = "darkgrey")) +
  labs(title = "Cluster Distribution by Group", 
       x = "Cluster", 
       y = "Frequency",
       fill = "Academic Status") + # Legend Title for fill 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("3-2-cluster_distribution.png", path = here("figures"), height = 4, width = 4)
```



## Textlength and Academic Status

### Mean, SD, T-Test 

```{r}
# logged textlength
data %>%
  group_by(academic_status) %>%
  get_summary_stats(text_length_log2, type = "mean_sd")

# Base R version
res <- t.test(text_length ~ academic_status, data = data)
res

# statix version
stat.test <- data %>% 
  t_test(text_length ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "text_length", 
  ylab = "Text Length", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```



## Readability and Academic Status

### T-Test

```{r}
# Base R version
res <- t.test(readability_score ~ academic_status, data = data)
res

# t-test
stat.test <- data %>% 
  t_test(readability_score ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "readability_score", 
  ylab = "readability_score", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```

## Cluster Group and Academic Status: Chi-Square Test

Chi-square test of independence: interested in testing whether there's a significant association between the two categorical variables (group and cluster)

```{r}
# Create the contingency table
table <- table(data$academic_status, data$cluster)
table

# Conduct Chi-square test of independence
chi_test_result <- chisq.test(table)

# Print the results
print(chi_test_result)
```

The p-value is 0.06, which is slightly above my alpha level of 0.05. This means my result is not significant (Aktueller Stand: 28. MÃ¤rz mit ca. 1000 observations).


```{r}
# Simple bar plot
barplot(table, beside=TRUE, legend=TRUE)
```



### Distribution and Shares (just as extra)

```{r}
crosstab(data$cluster, data$academic_status, prop.r = TRUE)

crosstab(data$cluster, data$academic_status, prop.c = TRUE)

ggplot(data, aes(x = cluster, fill = academic_status)) +
  geom_bar(position = "dodge") +
  labs(title = "Number of Observations per Cluster, Grouped by Academic Status",
       x = "Cluster",
       y = "Number of Observations") +
  theme_minimal()
```


## Prediction of Political Orientation and Academic Status

### T-Test

```{r}
# Base R version
res <- t.test(leftright_pred_error ~ academic_status, data = data)
res

# t-test
stat.test <- data %>% 
  t_test(leftright_pred_error ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "leftright_pred_error", 
  ylab = "leftright pred score", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```



# Differences in indicators between three edcucation levels

## Indicators by Education Category

```{r}
p <- ggpairs(data,                 # Data frame
        columns = indicators, # Columns
        aes(color = educ_cat,  # Color by group (cat. variable)
            alpha = 0.5),
        upper = list(continuous = wrap("cor", size = 2.7)
        ))

p
```


### Example how to extract single plots

```{r}
getPlot(p, 1, 4)
```

## Textlength and Education Cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = text_length_log2)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Text Length by Education",
       x = "Academic Status",
       y = "Text Length")

# Print the plot
print(p)

```

## Readability and educ_cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = readability_score)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Readability by Education",
       x = "Academic Status",
       y = "Readability Score")

# Print the plot
print(p)

```

## Prediction of Political Orientation and educ_cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = leftright_pred_error)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Prediction of Political Orientation by educ_cat",
       x = "Education",
       y = "Readability Score")

# Print the plot
print(p)

```


# Density Curves

## Density Curves for Academic Status

```{r}
# Define the function
plot_density_comparison <- function(data, numeric_var_name, group_var_name = "academic_status") {
  # Ensure the variable names are non-empty and exist in the dataframe
  if (!numeric_var_name %in% names(data)) {
    stop("Numeric variable name does not exist in the dataframe.")
  }
  
  if (!group_var_name %in% names(data)) {
    stop("Group variable name does not exist in the dataframe.")
  }
  
  # Use ggplot to create the density plot
  p <- ggplot(data, aes_string(x = numeric_var_name, fill = group_var_name)) +
    geom_density(alpha = 0.5) + # Adjust alpha for transparency
    labs(x = numeric_var_name, y = "Density") + # Labels
    ggtitle(paste("Density of", numeric_var_name, "by", group_var_name)) +
    scale_fill_manual(values = c("academic" = "skyblue", "non-academic" = "pink")) + # Customize colors
    theme_minimal() # Use a minimal theme for a nicer plot
  
  return(p)
}

# Example usage with your dataframe 'data' and the variable 'readability_score'
plot1 <- plot_density_comparison(data, "text_length_log2")

# For readability_score
plot2 <- plot_density_comparison(data, "readability_score")

# For leftright_pred_error
plot3 <- plot_density_comparison(data, "leftright_pred_error")

# add type/cluster indicator later

plot1
plot2
plot3
```

## Density Curves for Education Category

```{r}
# Define the function
plot_density_comparison <- function(data, numeric_var_name, group_var_name = "educ_cat") {
  # Ensure the variable names are non-empty and exist in the dataframe
  if (!numeric_var_name %in% names(data)) {
    stop("Numeric variable name does not exist in the dataframe.")
  }
  
  if (!group_var_name %in% names(data)) {
    stop("Group variable name does not exist in the dataframe.")
  }
  
  # Use ggplot to create the density plot
  p <- ggplot(data, aes_string(x = numeric_var_name, fill = group_var_name)) +
    geom_density(alpha = 0.5) + # Adjust alpha for transparency
    labs(x = numeric_var_name, y = "Density") + # Labels
    ggtitle(paste("Density of", numeric_var_name, "by", group_var_name)) +
    scale_fill_manual(values = c("High" = "skyblue", "Intermediate" = "lightgreen", "Low" = "pink")) + # Customize colors
    theme_minimal() # Use a minimal theme for a nicer plot
  
  return(p)
}

# Example usage with your dataframe 'data' and the variable 'text_length_log2'
plot5 <- plot_density_comparison(data, "text_length_log2")

# For readability_score
plot6 <- plot_density_comparison(data, "readability_score")

# For leftright_pred_error
plot7 <- plot_density_comparison(data, "leftright_pred_error")

# add type/cluster indicator later

plot5
plot6
plot7
```

### Facet Wrap of the Plots

DID NOT WORK YET!!

```{r}
#library(patchwork)
#
## Assuming plot1, plot2, plot3, plot5, plot6, plot7 are your ggplot objects
#plot_layout <- plot1 + plot2 + plot3 + plot5 + plot6 + plot7 +
#  plot_layout(guides = "collect") &
#  theme(legend.position = "bottom")
#
#plot_layout <- plot1 + plot2 + plot3 + plot5 + plot6 + plot7 +
#  plot_layout(ncol = 2) # This is the correct usage to specify layout options
#
#
#plot_layout
```

