---
title: "Group Analysis"
author: "Johanna Mehler"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true               # Enable Table of Contents
    toc_float:              # Make the TOC floating
      collapsed: false      # Do not collapse TOC by default
      smooth_scroll: true   # Smooth scrolling to sections
    number_sections: true   # Numbered sections
    theme: readable         # Use a predefined theme for styling (optional)
    highlight: tango        # Syntax highlighting style (optional)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Differences in indicators between academic status groups

## Data preparation

```{r}
library(tidyverse)
library(here)
library(ggplot2)
library(descr)
library(GGally)
library(ggpubr)
library(rstatix)

data <- read_csv(here("data/data_combined.csv"))

# filter out NA's in academic status and extreme outliers
data <- data %>% filter(!is.na(educ_cat), !is.na(academic_status), text_length_abs < 1000, readability_score < 40)

indicators <- c("text_length", "readability_score", "leftright_pred_score", "cluster")
```

## Indicators by Academic Status

```{r}
p <- ggpairs(data,                 # Data frame
        columns = indicators, # Columns
        aes(color = academic_status,  # Color by group (cat. variable)
            alpha = 0.5),
        upper = list(continuous = wrap("cor", size = 2.7)
        ))

p
```


### Example how to extract single plots

```{r}
getPlot(p, 1, 4)
```



## Textlength and Academic Status

### Mean, SD, T-Test 

```{r}
# logged textlength
data %>%
  group_by(academic_status) %>%
  get_summary_stats(text_length, type = "mean_sd")

# Base R version
res <- t.test(text_length ~ academic_status, data = data)
res

# statix version
stat.test <- data %>% 
  t_test(text_length ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "text_length", 
  ylab = "Text Length", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```

The T-Test shows no significance!


## Readability and Academic Status

### T-Test

```{r}
# t-test
stat.test <- data %>% 
  t_test(readability_score ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "readability_score", 
  ylab = "readability_score", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```

## Cluster Group and Academic Status: Chi-Square Test

Chi-square test of independence: interested in testing whether there's a significant association between the two categorical variables (group and cluster)

```{r}
# Create the contingency table
table <- table(data$academic_status, data$cluster)
table

# Conduct Chi-square test of independence
chi_test_result <- chisq.test(table)

# Print the results
print(chi_test_result)
```

The p-value is 0.06, which is slightly above my alpha level of 0.05. This means my result is not significant (Aktueller Stand: 28. MÃ¤rz mit ca. 1000 observations).


```{r}
# Simple bar plot
barplot(table, beside=TRUE, legend=TRUE)
```



### Distribution and Shares (just as extra)

```{r}
crosstab(data$cluster, data$academic_status, prop.c = TRUE)


ggplot(data, aes(x = cluster, fill = academic_status)) +
  geom_bar(position = "dodge") +
  labs(title = "Number of Observations per Cluster, Grouped by Academic Status",
       x = "Cluster",
       y = "Number of Observations") +
  theme_minimal()
```


## Prediction of Political Orientation and Academic Status

### T-Test

```{r}
# t-test
stat.test <- data %>% 
  t_test(leftright_pred_score ~ academic_status, detailed = TRUE) %>%
  add_significance()
stat.test

# Create a box-plot
bxp <- ggboxplot(
  data, x = "academic_status", y = "leftright_pred_score", 
  ylab = "leftright pred score", xlab = "Groups", add = "jitter"
  )

# Add p-value and significance levels
stat.test <- stat.test %>% add_xy_position(x = "academic_status")
bxp + 
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
```



# Differences in indicators between three edcucation levels

## Indicators by Education Category

```{r}
p <- ggpairs(data,                 # Data frame
        columns = indicators, # Columns
        aes(color = educ_cat,  # Color by group (cat. variable)
            alpha = 0.5),
        upper = list(continuous = wrap("cor", size = 2.7)
        ))

p
```


### Example how to extract single plots

```{r}
getPlot(p, 1, 4)
```

## Textlength and Education Cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = text_length)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Text Length by Education",
       x = "Academic Status",
       y = "Text Length")

# Print the plot
print(p)

```

## Readability and educ_cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = readability_score)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Readability by Education",
       x = "Academic Status",
       y = "Readability Score")

# Print the plot
print(p)

```

## Prediction of Political Orientation and educ_cat

```{r}
# Create the box plot
p <- ggplot(data, aes(x = educ_cat, y = leftright_pred_score)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, color = "skyblue") +
  geom_boxplot(outliers = FALSE) +
  theme_minimal() +
  labs(title = "Comparison of Prediction of Political Orientation by educ_cat",
       x = "Education",
       y = "Readability Score")

# Print the plot
print(p)

```


# Density Curves

## Density Curves for Academic Status

```{r}
# Define the function
plot_density_comparison <- function(data, numeric_var_name, group_var_name = "academic_status") {
  # Ensure the variable names are non-empty and exist in the dataframe
  if (!numeric_var_name %in% names(data)) {
    stop("Numeric variable name does not exist in the dataframe.")
  }
  
  if (!group_var_name %in% names(data)) {
    stop("Group variable name does not exist in the dataframe.")
  }
  
  # Use ggplot to create the density plot
  p <- ggplot(data, aes_string(x = numeric_var_name, fill = group_var_name)) +
    geom_density(alpha = 0.5) + # Adjust alpha for transparency
    labs(x = numeric_var_name, y = "Density") + # Labels
    ggtitle(paste("Density of", numeric_var_name, "by", group_var_name)) +
    scale_fill_manual(values = c("academic" = "skyblue", "non-academic" = "pink")) + # Customize colors
    theme_minimal() # Use a minimal theme for a nicer plot
  
  return(p)
}

# Example usage with your dataframe 'data' and the variable 'readability_score'
plot1 <- plot_density_comparison(data, "text_length")

# For readability_score
plot2 <- plot_density_comparison(data, "readability_score")

# For leftright_pred_score
plot3 <- plot_density_comparison(data, "leftright_pred_score")

# add type/cluster indicator later

plot1
plot2
plot3
```

## Density Curves for Education Category

```{r}
# Define the function
plot_density_comparison <- function(data, numeric_var_name, group_var_name = "educ_cat") {
  # Ensure the variable names are non-empty and exist in the dataframe
  if (!numeric_var_name %in% names(data)) {
    stop("Numeric variable name does not exist in the dataframe.")
  }
  
  if (!group_var_name %in% names(data)) {
    stop("Group variable name does not exist in the dataframe.")
  }
  
  # Use ggplot to create the density plot
  p <- ggplot(data, aes_string(x = numeric_var_name, fill = group_var_name)) +
    geom_density(alpha = 0.5) + # Adjust alpha for transparency
    labs(x = numeric_var_name, y = "Density") + # Labels
    ggtitle(paste("Density of", numeric_var_name, "by", group_var_name)) +
    scale_fill_manual(values = c("High" = "skyblue", "Intermediate" = "lightgreen", "Low" = "pink")) + # Customize colors
    theme_minimal() # Use a minimal theme for a nicer plot
  
  return(p)
}

# Example usage with your dataframe 'data' and the variable 'text_length'
plot5 <- plot_density_comparison(data, "text_length")

# For readability_score
plot6 <- plot_density_comparison(data, "readability_score")

# For leftright_pred_score
plot7 <- plot_density_comparison(data, "leftright_pred_score")

# add type/cluster indicator later

plot5
plot6
plot7
```

### Facet Wrap of the Plots

DID NOT WORK YET!!

```{r}
#library(patchwork)
#
## Assuming plot1, plot2, plot3, plot5, plot6, plot7 are your ggplot objects
#plot_layout <- plot1 + plot2 + plot3 + plot5 + plot6 + plot7 +
#  plot_layout(guides = "collect") &
#  theme(legend.position = "bottom")
#
#plot_layout <- plot1 + plot2 + plot3 + plot5 + plot6 + plot7 +
#  plot_layout(ncol = 2) # This is the correct usage to specify layout options
#
#
#plot_layout
```

